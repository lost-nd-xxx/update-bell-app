# 開発ガイドライン (Development Guide)

このドキュメントは、`update-bell-app`プロジェクトの開発における規約、設計思想、および重要な注意点を記載します。
開発に参加するすべてのメンバー（人間とAIエージェントを含む）は、このガイドラインに従ってください。

## 1. 開発環境と必須コマンド

### 環境変数の設定

APIをローカルでテストするには、Vercel上のプロジェクトに設定されている環境変数をローカルに取得する必要があります。

**手順:**

1.  **Vercel CLI のインストール:**
    まだインストールしていない場合は、以下のコマンドでグローバルインストールしてください。

    ```bash
    npm install -g vercel
    ```

2.  **Vercel へのログイン:**
    ブラウザが開き、Vercelアカウントにログインするよう求められます。

    ```bash
    vercel login
    ```

3.  **プロジェクトのリンク:**
    プロジェクトのルートディレクトリで実行し、Vercel上のプロジェクトとローカルリポジトリを紐付けます。指示に従ってプロジェクトを選択してください。

    ```bash
    vercel link
    ```

4.  **環境変数の取得:**
    Vercel上のプロジェクトに設定されている環境変数をローカルにプルします。これにより、APIがVercel KVなどのサービスに接続できるようになります。

    ```bash
    vercel env pull .env
    ```

    **重要:** このコマンドでは、バックエンド用の環境変数（`UPSTASH_REDIS_REST_URL`など）のみが取得されます。フロントエンド用の環境変数（`VITE_`プレフィックス）は自動的に取得されないため、手動で追加する必要があります。

5.  **フロントエンド用環境変数の追加:**
    `.env` ファイルに、VAPID公開鍵を手動で追加してください。

    ```env
    VITE_VAPID_PUBLIC_KEY="your-vapid-public-key-here"
    ```

    VAPID公開鍵の値は、Vercelダッシュボードの環境変数設定から確認できます。新規に生成する場合は、以下のコマンドで生成できます。

    ```bash
    npx web-push generate-vapid-keys
    ```

    生成された公開鍵（Public Key）を上記の設定に使用し、秘密鍵（Private Key）はVercelの環境変数 `VAPID_PRIVATE_KEY` として設定してください。

6.  **KVデータの分離 (開発時の安全確保):**
    上記の手順でプルされた環境変数を使用してKVに接続すると、デフォルトではVercelの指定されたKVインスタンス（多くの場合、本番環境のデータ）に直接アクセスします。ローカルでのテストが本番データに影響を与えないように、**KVキーにプレフィックスを付与する** 方法を採用しています。

    `.env` ファイルに以下の行を追加してください。

    ```env
    KV_PREFIX="dev:"
    ```

    この設定により、ローカル環境からのKV操作は全て `dev:` で始まるキーに対して行われるため、本番データとは完全に分離されます。テストが完了したら、この行をコメントアウトするか削除することで、通常の状態に戻すことができます。

    **重要:** `.env` ファイルは `.gitignore` に含まれているため、誤ってコミットされることはありません。

### 開発サーバーの起動（コマンドの使い分け）

目的に応じて、以下のコマンドを使い分けてください。

#### A. フロントエンド開発・UI確認（本番API接続）

主に画面の見た目やコンポーネントの動作を確認する場合は、こちらを使用します。起動が高速です。

```bash
npm run dev
```

- **特徴:** Vite開発サーバーを**HTTP**で起動します。証明書設定などが不要で最も手軽です。
- **API:** `vite.config.ts`の`server.proxy`設定により、APIリクエストは**本番環境 (update-bell-app.vercel.app)** にプロキシされます。
- **ポート:** `localhost:5173`

#### B. PWA機能・HTTPS動作確認

Service Workerの登録やPWAのインストール機能など、HTTPSが必須となる機能を確認する場合に使用します。

```bash
npm run dev:https
```

- **特徴:** Vite開発サーバーを**HTTPS**で起動します。
- **要件:** プロジェクトルートに `mkcert` で生成した `localhost.pem` と `localhost-key.pem` が必要です。
- **API:** `npm run dev` と同様に、本番環境にプロキシされます。
- **ポート:** `https://localhost:5173`

#### C. API連携・統合テスト（ローカルAPIサーバー使用）

API (Serverless Functions) や KV との連携を含めた完全な動作確認を行う場合は、こちらを使用します。

**VSCodeタスクを使用する場合（推奨）:**

VSCodeのコマンドパレット（`Ctrl+Shift+P` または `Cmd+Shift+P`）から「Tasks: Run Task」を選択し、「ローカル開発環境起動 (API + Vite)」を実行してください。これにより、ローカルAPIサーバーとVite開発サーバーが同時に起動します。

**手動で起動する場合:**

ターミナルを2つ開き、それぞれで以下のコマンドを実行してください。

ターミナル1（ローカルAPIサーバー）:

```bash
npm run dev:api
```

ターミナル2（Vite開発サーバー）:

```bash
npm run dev:vercel
```

- **特徴:**
  - `npm run dev:api` は、`api/` ディレクトリ内のServerless FunctionsをExpressサーバーとして起動します（`localhost:3000`）。
  - `npm run dev:vercel` は、Viteを`vercel-dev`モードで起動し、APIリクエストをローカルAPIサーバー（`localhost:3000`）にプロキシします（`localhost:5173`）。
- **API:** ローカルで動作するAPIサーバーに接続されるため、`.env`で設定したKVなどに接続します。
- **ポート:**
  - ローカルAPIサーバー: `localhost:3000`
  - Vite開発サーバー: `localhost:5173`
- **注意:**
  - 初回は環境変数の設定が必要です（前述の「環境変数の設定」参照）。
  - Vercel CLIによる`vercel dev`は、ViteのHMR（Hot Module Replacement）との互換性の問題からECONNRESETエラーが発生するため、ExpressベースのローカルAPIサーバーを採用しています。

### コミット前のチェック

コードをコミットする前には、必ず以下のコマンドを実行し、静的解析とフォーマットをパスすることを確認してください。

```bash
npm run check:fix
```

これにより、コードの品質と一貫性が保たれます。

## 2. 設計思想と重要な仕様

### 通知設定のインポート/エクスポート

- **インポート:** JSONファイルからのインポートでは、通知方法（ローカル/プッシュ）は**現在のアプリの設定を維持します**。インポートデータに含まれる通知方法の設定は意図的に無視されます。
- **エクスポート:** エクスポートされるJSONデータには、通知方法は含まれません。

**理由:**
「データのインポート」と「通知設定の変更」という、副作用の大きさが異なる操作を明確に分離し、ユーザーが意図しないデータ損失や設定変更を防ぐためです。

### アカウント機能とデバイス管理

- 本アプリケーションは、意図的にユーザーアカウント登録機能を実装していません。
- そのため、複数デバイス間で設定やデータを自動的に同期するシナリオはサポートしていません。
- プッシュ通知の購読管理は、各ブラウザ（デバイス）で閉じており、通知方法のラジオボタン操作に集約されています。

## 3. コミットメッセージのガイドライン

コミットメッセージは、Conventional Commitsの規約に準拠し、日本語で記述してください。

- **フォーマット:** `[Prefix]: [簡潔な内容]`
- **Prefixの例:**
  - `feat`: 新機能の追加
  - `fix`: バグ修正
  - `refactor`: パフォーマンス向上や可読性向上など、仕様に影響しないコード修正
  - `docs`: ドキュメントの追加・修正
  - `chore`: ビルドプロセスや補助ツールの変更など（`.gitignore`の修正など）
- **本文:** 変更の理由や背景を簡潔に記述します（任意）。
