# 開発ガイドライン (Development Guide)

このドキュメントは、`update-bell-app`プロジェクトの開発における規約、設計思想、および重要な注意点を記載します。
開発に参加するすべてのメンバー（人間とAIエージェントを含む）は、このガイドラインに従ってください。

## 1. 開発環境と必須コマンド

### Vercel CLI を使用したローカルAPIテスト

API (Vercel Serverless Functions) や Vercel KV を含むアプリケーション全体をローカルでテストするには、Vercel CLIを使用することを強く推奨します。これにより、本番環境に近い動作をローカルで再現できます。

**手順:**

1.  **Vercel CLI のインストール:**
    まだインストールしていない場合は、以下のコマンドでグローバルインストールしてください。

    ```bash
    npm install -g vercel
    ```

2.  **Vercel へのログイン:**
    ブラウザが開き、Vercelアカウントにログインするよう求められます。

    ```bash
    vercel login
    ```

3.  **プロジェクトのリンク:**
    プロジェクトのルートディレクトリで実行し、Vercel上のプロジェクトとローカルリポジトリを紐付けます。指示に従ってプロジェクトを選択してください。

    ```bash
    vercel link
    ```

4.  **環境変数の取得:**
    Vercel上のプロジェクトに設定されている環境変数をローカルにプルします。これにより、APIがVercel KVなどのサービスに接続できるようになります。
    **重要:** これで取得される環境変数が本番環境のものに紐付いている場合、ローカルでの操作が本番データに影響を与える可能性があります。

    ```bash
    vercel env pull .env.local
    ```

5.  **KVデータの分離 (開発時の安全確保):**
    上記の手順でプルされた環境変数を使用してKVに接続すると、デフォルトではVercelの指定されたKVインスタンス（多くの場合、本番環境のデータ）に直接アクセスします。ローカルでのテストが本番データに影響を与えないように、**KVキーにプレフィックスを付与する** 方法を採用しています。

    `.env.local` ファイルに以下の行を追加してください。

    ```env
    KV_PREFIX="dev:"
    ```

    この設定により、ローカル環境からのKV操作は全て `dev:` で始まるキーに対して行われるため、本番データとは完全に分離されます。テストが完了したら、この行をコメントアウトするか削除することで、通常の状態に戻すことができます。

6.  **ローカル開発サーバーの起動 (API含む):**
    Vite開発サーバーの代わりに `vercel dev` コマンドを使用します。ポート競合を防ぐため、3001番ポートでの起動を推奨します。
    ```bash
    vercel dev --listen 3001
    ```
    これにより、`localhost:3001` でフロントエンドとAPIの両方が起動し、完全に統合された環境でテストできます。
    ※ `.env` ファイルに環境変数を定義しておくと、より確実に読み込まれます。

### 開発サーバーの起動（コマンドの使い分け）

目的に応じて、以下のコマンドを使い分けてください。

#### A. フロントエンド開発・UI確認 (推奨)

主に画面の見た目やコンポーネントの動作を確認する場合は、こちらを使用します。起動が高速です。

```bash
npm run dev
```

- **特徴:** Vite開発サーバーを**HTTP**で起動します。証明書設定などが不要で最も手軽です。
- **API:** `vite.config.ts`の`server.proxy`設定により、APIリクエストは特定のターゲットにプロキシされる場合がありますが、基本的にはAPIモックを使用するか、APIエラーを許容した開発になります。

#### B. PWA機能・HTTPS動作確認

Service Workerの登録やPWAのインストール機能など、HTTPSが必須となる機能を確認する場合に使用します。

```bash
npm run dev:https
```

- **特徴:** Vite開発サーバーを**HTTPS**で起動します。
- **要件:** プロジェクトルートに `mkcert` で生成した `localhost.pem` と `localhost-key.pem` が必要です。

#### C. API連携・統合テスト

API (Serverless Functions) や KV との連携を含めた完全な動作確認を行う場合は、こちらを使用します。

```bash
vercel dev --listen 3001
```

- **特徴:** Vercelの実行環境をローカルでエミュレートします（内部で `npm run dev:vercel` を実行し、HTTPで起動したViteを取り込みます）。
- **ポート:** ポート競合を避けるため、`--listen 3001` オプションを付けて **3001番ポート** で起動することを推奨します。
- **API:** `api/` ディレクトリ内の関数が実際に動作し、`.env.local`で設定したKVなどに接続します。
- **注意:** 初回は`vercel login`や`vercel link`などのセットアップが必要です（前述の「Vercel CLI を使用したローカルAPIテスト」参照）。

### コミット前のチェック

コードをコミットする前には、必ず以下のコマンドを実行し、静的解析とフォーマットをパスすることを確認してください。

```bash
npm run check:fix
```

これにより、コードの品質と一貫性が保たれます。

## 2. 設計思想と重要な仕様

### 通知設定のインポート/エクスポート

- **インポート:** JSONファイルからのインポートでは、通知方法（ローカル/プッシュ）は**現在のアプリの設定を維持します**。インポートデータに含まれる通知方法の設定は意図的に無視されます。
- **エクスポート:** エクスポートされるJSONデータには、通知方法は含まれません。

**理由:**
「データのインポート」と「通知設定の変更」という、副作用の大きさが異なる操作を明確に分離し、ユーザーが意図しないデータ損失や設定変更を防ぐためです。

### アカウント機能とデバイス管理

- 本アプリケーションは、意図的にユーザーアカウント登録機能を実装していません。
- そのため、複数デバイス間で設定やデータを自動的に同期するシナリオはサポートしていません。
- プッシュ通知の購読管理は、各ブラウザ（デバイス）で閉じており、通知方法のラジオボタン操作に集約されています。

## 3. コミットメッセージのガイドライン

コミットメッセージは、Conventional Commitsの規約に準拠し、日本語で記述してください。

- **フォーマット:** `[Prefix]: [簡潔な内容]`
- **Prefixの例:**
  - `feat`: 新機能の追加
  - `fix`: バグ修正
  - `refactor`: パフォーマンス向上や可読性向上など、仕様に影響しないコード修正
  - `docs`: ドキュメントの追加・修正
  - `chore`: ビルドプロセスや補助ツールの変更など（`.gitignore`の修正など）
- **本文:** 変更の理由や背景を簡潔に記述します（任意）。
